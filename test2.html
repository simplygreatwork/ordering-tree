<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="user-scalable=1.0,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0">
		<title>Ordering Example: Main</title>
	</head>
	<body>
		
		<script type="module">
			
			import { system_initialize } from './core.js'
			import { catalog_initialize } from './core.js'
			import { order_initialize, order_append } from './core.js'
			import { order_item_increment, order_item_decrement, order_item_set } from './core.js'
			import { order_validate } from './core.js'
			import { order_serialize } from './core.js'
			
			function run() {
				
				let tests = []
				let it = function(label, fn) {
					tests.push({ label: label, fn, fn })
				}
				
				it('append item', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/drink/fountain +2.09 Fountain_Drink 0 #
					`)
					let order = system.order = order_initialize()
					order_append(order, '/drink/fountain')
					return matches(order_serialize(order), `
						/drink/fountain 1
					`)
				})
				
				it('append item then increment', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/drink/fountain +2.09 Fountain_Drink 0 #
					`)
					let order = system.order = order_initialize()
					order_append(order, '/drink/fountain')
					order_item_increment(order.items[0], '/drink/fountain')
					return matches(order_serialize(order), `
						/drink/fountain 2
					`)
				})
				
				it('append item then increment twice', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/drink/fountain +2.09 Fountain_Drink 0 #
					`)
					let order = system.order = order_initialize()
					order_append(order, '/drink/fountain')
					order_item_increment(order.items[0], '/drink/fountain')
					order_item_increment(order.items[0], '/drink/fountain')
					return matches(order_serialize(order), `
						/drink/fountain 3
					`)
				})
				
				it('append item then set quantity', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/drink/fountain +2.09 Fountain_Drink 0 #
					`)
					let order = system.order = order_initialize()
					order_append(order, '/drink/fountain')
					order_item_set(order.items[0], '/drink/fountain', 5)
					return matches(order_serialize(order), `
						/drink/fountain 5
					`)
				})
				
				it('append item then decrement twice then increment', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/drink/fountain +2.09 Fountain_Drink 0 #
					`)
					let order = system.order = order_initialize()
					order_append(order, '/drink/fountain')
					order_item_decrement(order.items[0], '/drink/fountain')
					order_item_decrement(order.items[0], '/drink/fountain')
					order_item_increment(order.items[0], '/drink/fountain')
					return matches(order_serialize(order), `
						/drink/fountain 1
					`)
				})
				
				it('append item then decrement twice', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/drink/fountain +2.09 Fountain_Drink 0 #
					`)
					let order = system.order = order_initialize()
					order_append(order, '/drink/fountain')
					order_item_decrement(order.items[0], '/drink/fountain')
					order_item_decrement(order.items[0], '/drink/fountain')
					return matches(order_serialize(order), ``)
				})
				
				it('append item with submenu', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/drink/fountain +2.09 Fountain_Drink 0 #
						/drink/fountain/flavor 0 Flavor 0
						/drink/fountain/flavor/coke 0 Flavor 0
						/drink/fountain/flavor/pepsi 0 Flavor 0
					`)
					let order = system.order = order_initialize()
					order_append(order, '/drink/fountain')
					return matches(order_serialize(order), `
						/drink/fountain 1
					`)
				})
				
				it('append item with modifers with default choice', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/drink/fountain +2.09 Fountain_Drink 0 #
						/drink/fountain/flavor 0 Flavor 0
						/drink/fountain/flavor/coke 0 Flavor 1
						/drink/fountain/flavor/pepsi 0 Flavor 0
					`)
					let order = system.order = order_initialize()
					order_append(order, '/drink/fountain')
					return matches(order_serialize(order), `
						/drink/fountain 1
						/drink/fountain/flavor/coke 1
					`)
				})
				
				it('append item then decrement modifer then increment modifer', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/drink/fountain +2.09 Fountain_Drink 0 #
						/drink/fountain/flavor 0 Flavor 0
						/drink/fountain/flavor/coke 0 Flavor 1
						/drink/fountain/flavor/pepsi 0 Flavor 0
					`)
					let order = system.order = order_initialize()
					order_append(order, '/drink/fountain')
					order_item_decrement(order.items[0], '/drink/fountain/flavor/coke')
					order_item_increment(order.items[0], '/drink/fountain/flavor/pepsi')
					return matches(order_serialize(order), `
						/drink/fountain 1
						/drink/fountain/flavor/pepsi 1
					`)
				})
				
				it('append item then increment modifer using single selection', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/drink/fountain +2.09 Fountain_Drink 0 #
						/drink/fountain/flavor 0 Flavor 0 !
						/drink/fountain/flavor/coke 0 Flavor 0
						/drink/fountain/flavor/pepsi 0 Flavor 0
					`)
					let order = system.order = order_initialize()
					order_append(order, '/drink/fountain')
					return order_validate(order) === false
				})
				
				it('append item then increment modifer prohibiting multiples', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/drink/fountain +2.09 Fountain_Drink 0 #
						/drink/fountain/flavor 0 Flavor 0 !
						/drink/fountain/flavor/coke 0 Flavor 0
						/drink/fountain/flavor/pepsi 0 Flavor 1
					`)
					let order = system.order = order_initialize()
					order_append(order, '/drink/fountain')
					order_item_increment(order.items[0], '/drink/fountain/flavor/pepsi')
					return matches(order_serialize(order), `
						/drink/fountain 1
						/drink/fountain/flavor/pepsi 1
					`)
				})
				
				it('increment a modifier which does not allow multiples from default 1 to 2', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/sandwich/burger +4.49 Burger 0 #
						/sandwich/burger/topping 0 Topping 0
						/sandwich/burger/topping/cheese +1.00 Cheese 0
					`)
					let order = system.order = order_initialize()
					order_append(order, '/sandwich/burger')
					order_item_increment(order.items[0], '/sandwich/burger/topping/cheese')
					return matches(order_serialize(order), `
						/sandwich/burger 1
						/sandwich/burger/topping/cheese 1
					`)
				})
				
				it('increment a modifier which does not allow multiples from default 0 to 2', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/sandwich/burger +4.49 Burger 0 #
						/sandwich/burger/topping 0 Topping 0
						/sandwich/burger/topping/cheese +1.00 Cheese 0
					`)
					let order = system.order = order_initialize()
					order_append(order, '/sandwich/burger')
					order_item_increment(order.items[0], '/sandwich/burger/topping/cheese')
					order_item_increment(order.items[0], '/sandwich/burger/topping/cheese')
					return matches(order_serialize(order), `
						/sandwich/burger 1
						/sandwich/burger/topping/cheese 1
					`)
				})
				
				it('increment a modifier which does allow multiples from default 0 to 2', function() {
					
					let system = window.system = system_initialize()
					let catalog = system.catalog = catalog_initialize(`
						/sandwich/burger +4.49 Burger 0 #
						/sandwich/burger/topping 0 Topping 0
						/sandwich/burger/topping/cheese +1.00 Cheese 0 #
					`)
					let order = system.order = order_initialize()
					order_append(order, '/sandwich/burger')
					order_item_increment(order.items[0], '/sandwich/burger/topping/cheese')
					order_item_increment(order.items[0], '/sandwich/burger/topping/cheese')
					return matches(order_serialize(order), `
						/sandwich/burger 1
						/sandwich/burger/topping/cheese 2
					`)
				})
				
				let result = true
				
				tests.forEach(function(each, index) {
					let result_ = each.fn()
					let label = each.label
					if (label == '') label = `test ${index}`
					console.log(`${result_ === true ? 'passed' : 'failed'} (${label})`)
					if (result_ === false) result = false 
				})
				return result
			}
			
			function matches(a, b) {
				
				let clean = (x => x.trim().split('\n').map(x => x.trim()).filter(x => x.length > 0).join('\n'))
				return clean(a) == clean(b)
			}
			
			let result = run()
			console.log(`all tests passed: ${result}`)
			
		</script>
	</body>
</html>
